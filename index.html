<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2 Player Battle</title>
<style>
body{
  font-family:arial;
  text-align:center;
  background:#111;
  color:white;
}
button{
  font-size:20px;
  padding:15px;
  margin:10px;
}
#score{
  font-size:28px;
  margin:20px;
}
#roomCode{
  font-size:24px;
  color:yellow;
  margin:10px;
}
</style>
</head>
<body>

<h1>2 Player Battle</h1>

<button onclick="createRoom()">Create Room</button>
<button onclick="joinRoom()">Join Room</button>

<div id="roomCode"></div>

<div id="score">
You: <span id="me">0</span> |
Enemy: <span id="enemy">0</span>
</div>

<button onclick="tap()">TAP!</button>

<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script>
let peer;
let conn;
let myScore = 0;
let enemyScore = 0;

// memory for codes
const codeMap = {};

function randomLetters(){
  let letters = "abcdefghijklmnopqrstuvwxyz";
  let out = "";
  for(let i=0;i<4;i++){
    out += letters[Math.floor(Math.random()*letters.length)];
  }
  return out;
}

function randomNumbers(){
  return Math.floor(1000 + Math.random()*9000);
}

function generateCode(){
  return randomLetters() + "-" + randomNumbers();
}

function createRoom(){
  peer = new Peer();

  peer.on('open', id=>{
    let code = generateCode();
    codeMap[code] = id;   // store mapping locally
    document.getElementById("roomCode").innerText = "Room Code: " + code;

    // save mapping so another browser can find it
    localStorage.setItem(code, id);
  });

  peer.on('connection', connection=>{
    conn = connection;
    setupConnection();
  });
}

function joinRoom(){
  let code = prompt("Enter Room Code (abcd-1234):");
  let id = localStorage.getItem(code);

  if(!id){
    alert("Room not found!");
    return;
  }

  peer = new Peer();
  conn = peer.connect(id);
  conn.on('open', setupConnection);
}

function setupConnection(){
  conn.on('data', data=>{
    enemyScore = data;
    document.getElementById("enemy").innerText = enemyScore;

    if(enemyScore >= 20){
      alert("You Lose!");
    }
  });
}

function tap(){
  myScore++;
  document.getElementById("me").innerText = myScore;
  if(conn) conn.send(myScore);

  if(myScore >= 20){
    alert("You Win!");
  }
}
</script>

</body>
</html>
